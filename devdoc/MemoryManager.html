<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>The Roxie Memory Manager | HPCC Platform</title>
    <meta name="description" content="The HPCC-Platform from hpccsystems is an open source system for big data analysis. It uses a single language, platform and architecture to process data efficiently and fast.">
    <meta name="generator" content="VitePress v1.6.3">
    <link rel="preload stylesheet" href="/HPCC-Platform/assets/style.DC-OUqe1.css" as="style">
    <link rel="preload stylesheet" href="/HPCC-Platform/vp-icons.css" as="style">
    
    <script type="module" src="/HPCC-Platform/assets/app.DgdsQxIX.js"></script>
    <link rel="preload" href="/HPCC-Platform/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/HPCC-Platform/assets/chunks/theme.BM2P6TRV.js">
    <link rel="modulepreload" href="/HPCC-Platform/assets/chunks/framework.Do1Zayaf.js">
    <link rel="modulepreload" href="/HPCC-Platform/assets/devdoc_MemoryManager.md.CXiFONGZ.lean.js">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-d8b57b2d><!--[--><!--]--><!--[--><span tabindex="-1" data-v-fcbfc0e0></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-fcbfc0e0>Skip to content</a><!--]--><!----><header class="VPNav" data-v-d8b57b2d data-v-7ad780c2><div class="VPNavBar" data-v-7ad780c2 data-v-9fd4d1dd><div class="wrapper" data-v-9fd4d1dd><div class="container" data-v-9fd4d1dd><div class="title" data-v-9fd4d1dd><div class="VPNavBarTitle has-sidebar" data-v-9fd4d1dd data-v-9f43907a><a class="title" href="/HPCC-Platform/" data-v-9f43907a><!--[--><!--]--><!----><span data-v-9f43907a>HPCC Platform</span><!--[--><!--]--></a></div></div><div class="content" data-v-9fd4d1dd><div class="content-body" data-v-9fd4d1dd><!--[--><!--]--><div class="VPNavBarSearch search" data-v-9fd4d1dd><!--[--><!----><div id="local-search"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><span class="vp-icon DocSearch-Search-Icon"></span><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-9fd4d1dd data-v-afb2845e><span id="main-nav-aria-label" class="visually-hidden" data-v-afb2845e> Main Navigation </span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/HPCC-Platform/devdoc/README.html" tabindex="0" data-v-afb2845e data-v-815115f5><!--[--><span data-v-815115f5>Getting Started</span><!--]--></a><!--]--><!--[--><a class="VPLink link vp-external-link-icon VPNavBarMenuLink" href="https://hpccsystems.com" target="_blank" rel="noreferrer" tabindex="0" data-v-afb2845e data-v-815115f5><!--[--><span data-v-815115f5>hpccsystems.com</span><!--]--></a><!--]--><!--[--><a class="VPLink link vp-external-link-icon VPNavBarMenuLink" href="https://hpccsystems.com/download/release-notes/" target="_blank" rel="noreferrer" tabindex="0" data-v-afb2845e data-v-815115f5><!--[--><span data-v-815115f5>Changelog</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-9fd4d1dd data-v-3f90c1a5><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-3f90c1a5 data-v-be9742d9 data-v-b4ccac88><span class="check" data-v-b4ccac88><span class="icon" data-v-b4ccac88><!--[--><span class="vpi-sun sun" data-v-be9742d9></span><span class="vpi-moon moon" data-v-be9742d9></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-9fd4d1dd data-v-ef6192dc data-v-e71e869c><!--[--><a class="VPSocialLink no-icon" href="https://github.com/hpcc-systems/HPCC-Platform" aria-label="github" target="_blank" rel="noopener" data-v-e71e869c data-v-60a9a2d3><span class="vpi-social-github"></span></a><a class="VPSocialLink no-icon" href="https://www.linkedin.com/company/hpcc-systems/home" aria-label="linkedin" target="_blank" rel="noopener" data-v-e71e869c data-v-60a9a2d3><span class="vpi-social-linkedin"></span></a><a class="VPSocialLink no-icon" href="https://twitter.com/hpccsystems" aria-label="twitter" target="_blank" rel="noopener" data-v-e71e869c data-v-60a9a2d3><span class="vpi-social-twitter"></span></a><a class="VPSocialLink no-icon" href="https://www.facebook.com/hpccsystems" aria-label="facebook" target="_blank" rel="noopener" data-v-e71e869c data-v-60a9a2d3><span class="vpi-social-facebook"></span></a><a class="VPSocialLink no-icon" href="https://www.youtube.com/user/HPCCSystems" aria-label="youtube" target="_blank" rel="noopener" data-v-e71e869c data-v-60a9a2d3><span class="vpi-social-youtube"></span></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-9fd4d1dd data-v-f953d92f data-v-bfe7971f><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-bfe7971f><span class="vpi-more-horizontal icon" data-v-bfe7971f></span></button><div class="menu" data-v-bfe7971f><div class="VPMenu" data-v-bfe7971f data-v-20ed86d6><!----><!--[--><!--[--><!----><div class="group" data-v-f953d92f><div class="item appearance" data-v-f953d92f><p class="label" data-v-f953d92f>Appearance</p><div class="appearance-action" data-v-f953d92f><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-f953d92f data-v-be9742d9 data-v-b4ccac88><span class="check" data-v-b4ccac88><span class="icon" data-v-b4ccac88><!--[--><span class="vpi-sun sun" data-v-be9742d9></span><span class="vpi-moon moon" data-v-be9742d9></span><!--]--></span></span></button></div></div></div><div class="group" data-v-f953d92f><div class="item social-links" data-v-f953d92f><div class="VPSocialLinks social-links-list" data-v-f953d92f data-v-e71e869c><!--[--><a class="VPSocialLink no-icon" href="https://github.com/hpcc-systems/HPCC-Platform" aria-label="github" target="_blank" rel="noopener" data-v-e71e869c data-v-60a9a2d3><span class="vpi-social-github"></span></a><a class="VPSocialLink no-icon" href="https://www.linkedin.com/company/hpcc-systems/home" aria-label="linkedin" target="_blank" rel="noopener" data-v-e71e869c data-v-60a9a2d3><span class="vpi-social-linkedin"></span></a><a class="VPSocialLink no-icon" href="https://twitter.com/hpccsystems" aria-label="twitter" target="_blank" rel="noopener" data-v-e71e869c data-v-60a9a2d3><span class="vpi-social-twitter"></span></a><a class="VPSocialLink no-icon" href="https://www.facebook.com/hpccsystems" aria-label="facebook" target="_blank" rel="noopener" data-v-e71e869c data-v-60a9a2d3><span class="vpi-social-facebook"></span></a><a class="VPSocialLink no-icon" href="https://www.youtube.com/user/HPCCSystems" aria-label="youtube" target="_blank" rel="noopener" data-v-e71e869c data-v-60a9a2d3><span class="vpi-social-youtube"></span></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-9fd4d1dd data-v-6bee1efd><span class="container" data-v-6bee1efd><span class="top" data-v-6bee1efd></span><span class="middle" data-v-6bee1efd></span><span class="bottom" data-v-6bee1efd></span></span></button></div></div></div></div><div class="divider" data-v-9fd4d1dd><div class="divider-line" data-v-9fd4d1dd></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-d8b57b2d data-v-2488c25a><div class="container" data-v-2488c25a><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-2488c25a><span class="vpi-align-left menu-icon" data-v-2488c25a></span><span class="menu-text" data-v-2488c25a>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-2488c25a data-v-6b867909><button data-v-6b867909>Return to top</button><!----></div></div></div><aside class="VPSidebar" data-v-d8b57b2d data-v-42c4c606><div class="curtain" data-v-42c4c606></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-42c4c606><span class="visually-hidden" id="sidebar-aria-label" data-v-42c4c606> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="no-transition group" data-v-51288d80><section class="VPSidebarItem level-0" data-v-51288d80 data-v-0009425e><div class="item" role="button" tabindex="0" data-v-0009425e><div class="indicator" data-v-0009425e></div><h2 class="text" data-v-0009425e>General</h2><!----></div><div class="items" data-v-0009425e><!--[--><div class="VPSidebarItem level-1 is-link" data-v-0009425e data-v-0009425e><div class="item" data-v-0009425e><div class="indicator" data-v-0009425e></div><a class="VPLink link link" href="/HPCC-Platform/devdoc/README.html" data-v-0009425e><!--[--><p class="text" data-v-0009425e>Getting Started</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0009425e data-v-0009425e><div class="item" data-v-0009425e><div class="indicator" data-v-0009425e></div><a class="VPLink link link" href="/HPCC-Platform/devdoc/Development.html" data-v-0009425e><!--[--><p class="text" data-v-0009425e>Development Guide</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0009425e data-v-0009425e><div class="item" data-v-0009425e><div class="indicator" data-v-0009425e></div><a class="VPLink link link" href="/HPCC-Platform/devdoc/StyleGuide.html" data-v-0009425e><!--[--><p class="text" data-v-0009425e>C++ Style Guide</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0009425e data-v-0009425e><div class="item" data-v-0009425e><div class="indicator" data-v-0009425e></div><a class="VPLink link link" href="/HPCC-Platform/ecllibrary/StyleGuide.html" data-v-0009425e><!--[--><p class="text" data-v-0009425e>ECL Style Guide</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0009425e data-v-0009425e><div class="item" data-v-0009425e><div class="indicator" data-v-0009425e></div><a class="VPLink link link" href="/HPCC-Platform/devdoc/CodeSubmissions.html" data-v-0009425e><!--[--><p class="text" data-v-0009425e>Code Submission Guidelines</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0009425e data-v-0009425e><div class="item" data-v-0009425e><div class="indicator" data-v-0009425e></div><a class="VPLink link link" href="/HPCC-Platform/devdoc/CodeReviews.html" data-v-0009425e><!--[--><p class="text" data-v-0009425e>Code Review Guidelines</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0009425e data-v-0009425e><div class="item" data-v-0009425e><div class="indicator" data-v-0009425e></div><a class="VPLink link link" href="/HPCC-Platform/devdoc/DevDocs.html" data-v-0009425e><!--[--><p class="text" data-v-0009425e>Writing Developer Documentation</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0009425e data-v-0009425e><div class="item" data-v-0009425e><div class="indicator" data-v-0009425e></div><a class="VPLink link link" href="/HPCC-Platform/devdoc/userdoc/README.html" data-v-0009425e><!--[--><p class="text" data-v-0009425e>User Guides</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0009425e data-v-0009425e><div class="item" data-v-0009425e><div class="indicator" data-v-0009425e></div><a class="VPLink link link" href="/HPCC-Platform/devdoc/UserBuildAssets.html" data-v-0009425e><!--[--><p class="text" data-v-0009425e>Build on Github Actions</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-51288d80><section class="VPSidebarItem level-0 has-active" data-v-51288d80 data-v-0009425e><div class="item" role="button" tabindex="0" data-v-0009425e><div class="indicator" data-v-0009425e></div><h2 class="text" data-v-0009425e>Other</h2><!----></div><div class="items" data-v-0009425e><!--[--><div class="VPSidebarItem level-1 is-link" data-v-0009425e data-v-0009425e><div class="item" data-v-0009425e><div class="indicator" data-v-0009425e></div><a class="VPLink link link" href="/HPCC-Platform/devdoc/Workunits.html" data-v-0009425e><!--[--><p class="text" data-v-0009425e>Workunit Workflow</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0009425e data-v-0009425e><div class="item" data-v-0009425e><div class="indicator" data-v-0009425e></div><a class="VPLink link link" href="/HPCC-Platform/devdoc/CodeGenerator.html" data-v-0009425e><!--[--><p class="text" data-v-0009425e>Code Generator</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0009425e data-v-0009425e><div class="item" data-v-0009425e><div class="indicator" data-v-0009425e></div><a class="VPLink link link" href="/HPCC-Platform/devdoc/roxie.html" data-v-0009425e><!--[--><p class="text" data-v-0009425e>Roxie</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0009425e data-v-0009425e><div class="item" data-v-0009425e><div class="indicator" data-v-0009425e></div><a class="VPLink link link" href="/HPCC-Platform/devdoc/MemoryManager.html" data-v-0009425e><!--[--><p class="text" data-v-0009425e>Memory Manager</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0009425e data-v-0009425e><div class="item" data-v-0009425e><div class="indicator" data-v-0009425e></div><a class="VPLink link link" href="/HPCC-Platform/devdoc/Metrics.html" data-v-0009425e><!--[--><p class="text" data-v-0009425e>Metrics</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0009425e data-v-0009425e><div class="item" data-v-0009425e><div class="indicator" data-v-0009425e></div><a class="VPLink link link" href="/HPCC-Platform/devdoc/DevTestWithLDAP.html" data-v-0009425e><!--[--><p class="text" data-v-0009425e>Development Testing With LDAP</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-d8b57b2d data-v-9a6c75ad><div class="VPDoc has-sidebar has-aside" data-v-9a6c75ad data-v-e6f2a212><!--[--><!--]--><div class="container" data-v-e6f2a212><div class="aside" data-v-e6f2a212><div class="aside-curtain" data-v-e6f2a212></div><div class="aside-container" data-v-e6f2a212><div class="aside-content" data-v-e6f2a212><div class="VPDocAside" data-v-e6f2a212 data-v-cb998dce><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-cb998dce data-v-f610f197><div class="content" data-v-f610f197><div class="outline-marker" data-v-f610f197></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-f610f197>On this page</div><ul class="VPDocOutlineItem root" data-v-f610f197 data-v-53c99d69><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-cb998dce></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-e6f2a212><div class="content-container" data-v-e6f2a212><!--[--><!--]--><main class="main" data-v-e6f2a212><div style="position:relative;" class="vp-doc _HPCC-Platform_devdoc_MemoryManager" data-v-e6f2a212><div><h1 id="introduction" tabindex="-1">Introduction <a class="header-anchor" href="#introduction" aria-label="Permalink to &quot;Introduction&quot;">​</a></h1><p>This memory manager started life as the memory manager which was only used for the Roxie engine. It had several original design goals:</p><ul><li>Support link counted rows. (When the last reference is released the row is freed.)</li><li>Be as fast as possible on allocate and deallocate of small rows.</li><li>Allow rows serialized from slaves to be used directly without being cloned first.</li><li>Allow the memory used by a single query, or by all queries combined, to be limited, with graceful recovery.</li><li>Isolate roxie queries from one another, so that one query can&#39;t bring down all the rest by allocating too much memory.</li><li>Guarantee all the memory used by a query is freed when the query finishes, reducing the possibility of memory leaks.</li><li>Predictable behaviour with no pathogenic cases.</li></ul><p>(Note that efficient usage of memory does not appear on that list - the expectation when the memory manager was first designed was that Roxie queries would use minimal amounts of memory and speed was more important. Some subsequent changes e.g., Packed heaps, and configurable bucket sizes help mitigate that.)</p><h1 id="main-structure" tabindex="-1">Main Structure <a class="header-anchor" href="#main-structure" aria-label="Permalink to &quot;Main Structure&quot;">​</a></h1><p>The basic design is to reserve (but not commit) a single large block of memory in the virtual address space. This memory is subdivided into &quot;pages&quot;. (These are not the same as the os virtual memory pages. The memory manager pages are currently defined as 1Mb in size.)</p><h2 id="the-page-bitmap" tabindex="-1">The page bitmap <a class="header-anchor" href="#the-page-bitmap" aria-label="Permalink to &quot;The page bitmap&quot;">​</a></h2><p>The system uses a bitmap to indicate whether each page from the global memory has been allocated. All active IRowManager instances allocate pages from the same global memory space. To help reduce fragmentation allocations for single pages are fulfilled from one end of the address space, while allocations for multiple pages are fulfilled from the other.</p><h2 id="irowmanager" tabindex="-1">IRowManager <a class="header-anchor" href="#irowmanager" aria-label="Permalink to &quot;IRowManager&quot;">​</a></h2><p>This provides the primary interface for allocating memory. The size of a requested allocation is rounded up to the next &quot;bucket&quot; size, and the allocation is then satisfied by the heap associated with that bucket size. Different engines can specify different bucket sizes - an optional list is provided to setTotalMemoryLimit. Roxie tends to use fewer buckets to help reduce the number of active heaps. Thor uses larger numbers since it is more important to minimize the memory wasted.</p><p>Roxie uses a separate instance of IRowManager for each query. This provides the mechanism for limiting how much memory a query uses. Thor uses a single instance of an IRowManager for each slave/master.</p><h2 id="heaps" tabindex="-1">Heaps <a class="header-anchor" href="#heaps" aria-label="Permalink to &quot;Heaps&quot;">​</a></h2><p>Memory is allocated from a set of &quot;heaps - where each heap allocates blocks of memory of a single size. The heap exclusively owns a set of heaplet (each 1 page in size), which are held in a doubly linked list, and sub allocates memory from those heaplets.</p><p>Information about each heaplet is stored in the base of the page (using a class with virtual functions) and the address of an allocated row is masked to determine which heap object it belongs to, and how it should be linked/released etc. Any pointer not in the allocated virtual address (e.g., constant data) can be linked/released with no effect.</p><p>Each heaplet contains a high water mark of the address within the page that has already been allocated (freeBase), and a lockless singly-linked list of rows which have been released (r_block). Releasing a row is non-blocking and does not involve any spin locks or critical sections. However, this means that empty pages need to be returned to the global memory pool at another time. (This is done in releaseEmptyPages()).</p><p>When the last row in a page is released a flag (possibleEmptyPages) is set in its associated heap. * This is checked before trying to free pages from a particular heap, avoiding waiting on a lock and traversing a candidate list.</p><p>Any page which <em>might</em> contain some spare memory is added to a lockless spare memory linked list. * Items are popped from this list when a heap fails to allocate memory from the current heaplet. Each item is checked in turn if it has space before allocating a new heaplet. * The list is also walked when checking to see which pages can be returned to the global memory. The doubly linked heaplet list allows efficient freeing.</p><p>Each allocation has a link count and an allocator id associated with it. The allocator id represents the type of the row, and is used to determine what destructor needs to be called when the row is destroyed. (The count for a row also contains a flag in the top bit to indicate if it is fully constructed, and therefore valid for the destructor to be called.)</p><h2 id="huge-heap" tabindex="-1">Huge Heap <a class="header-anchor" href="#huge-heap" aria-label="Permalink to &quot;Huge Heap&quot;">​</a></h2><p>A specialized heap is used to manage all allocations that require more than one page of memory. These allocations are not held on a free list when they are released, but each is returned directly to the global memory pool. Allocations in the huge heap can be expanded and shrunk using the resizeRow() functions - see below.</p><h2 id="specialised-heaps" tabindex="-1">Specialised Heaps: <a class="header-anchor" href="#specialised-heaps" aria-label="Permalink to &quot;Specialised Heaps:&quot;">​</a></h2><h3 id="packed" tabindex="-1">Packed <a class="header-anchor" href="#packed" aria-label="Permalink to &quot;Packed&quot;">​</a></h3><p>By default a fixed size heaps rounds the requested allocation size up to the next bucket size. A packed heap changes this behaviour and it is rounded up to the next 4 byte boundary instead. This reduces the amount of memory wasted for each row, but potentially increases the number of distinct heaps.</p><h3 id="unique" tabindex="-1">Unique <a class="header-anchor" href="#unique" aria-label="Permalink to &quot;Unique&quot;">​</a></h3><p>By default all fixed size heaps of the same size are shared. This reduces the memory consumption, but if the heap is used by multiple threads it can cause significant contention. If a unique heap is specified then it will not be shared with any other requests. Unique heaps store information about the type of each row in the heaplet header, rather than per row - which reduces the allocation overhead for each row. (Note to self: Is there ever any advantage having a heap that is unique but not packed??)</p><h3 id="blocked" tabindex="-1">Blocked <a class="header-anchor" href="#blocked" aria-label="Permalink to &quot;Blocked&quot;">​</a></h3><p>Blocked is an option on createFixedRowHeap() to allocate multiple rows from the heaplet, and then return the additional rows on subsequent calls. It is likely to reduce the average number of atomic operations required for each row being allocated, but the heap that is returned can only be used from a single thread because it is not thread safe.</p><h3 id="scanning" tabindex="-1">Scanning <a class="header-anchor" href="#scanning" aria-label="Permalink to &quot;Scanning&quot;">​</a></h3><p>By default the heaplets use a lock free singly linked list to keep track of rows that have been freed. This requires an atomic operation for each allocation and for each free. The scanning allocator uses an alternative approach. When a row is freed the row header is marked, and a row is allocated by scanning through the heaplet for rows that have been marked as free. Scanning uses atomic store and get, rather than more expensive synchronized atomic operations, so is generally faster than the linked list - provided a free row is found fairly quickly.</p><p>The scanning heaps have better best-case performance, but worse worse-case performance (if large numbers of rows need to be scanned before a free row is found). The best-case tends to be true if only one thread/activity is accessing a particular heap, and the worse-case if multiple activities are accessing a heap, particularly if the rows are being buffered. It is the default for thor which tends to have few active allocators, but not for roxie, which tends to have large numbers of allocators.</p><h3 id="delay-release" tabindex="-1">Delay Release <a class="header-anchor" href="#delay-release" aria-label="Permalink to &quot;Delay Release&quot;">​</a></h3><p>This is another varation on the scanning allocator, which further reduces the number of atomic operations. Usually when a row is allocated the link count on the heaplet is increased, and when it is freed the link count is decremented. This option delays decrementing the link count when the row is released, by marking the row with a different free flag. If it is subsequently reallocated there is no need to increment the link count. The downside is that it is more expensive to check whether a heaplet is completely empty (since you can no longer rely on the heaplet linkcount alone).</p><h1 id="dynamic-spilling" tabindex="-1">Dynamic Spilling <a class="header-anchor" href="#dynamic-spilling" aria-label="Permalink to &quot;Dynamic Spilling&quot;">​</a></h1><p>Thor has additional requirements to roxie. In roxie, if a query exceeds its memory requirements then it is terminated. Thor needs to be able to spill rows and other memory to disk and continue. This is achieved by allowing any process that stores buffered rows to register a callback with the memory manager. When more memory is required these callbacks are called to free up memory, and allow the job to continue.</p><p>Each callback can specify a priority - lower priority callbacks are called first since they are assumed to have a lower cost associated with spilling. When more memory is required the callbacks are called in priority order until one of them succeeds. The can also be passed a flag to indicate it is critical to force them to free up as much memory as possible.</p><h2 id="complications" tabindex="-1">Complications <a class="header-anchor" href="#complications" aria-label="Permalink to &quot;Complications&quot;">​</a></h2><p>There are several different complications involved with the memory spilling:</p><ul><li>There will be many different threads allocating rows.</li><li>Callbacks could be triggered at any time.</li><li>There is a large scope for deadlock between the callbacks and allocations.</li><li>It may be better to not resize a large array if rows had to be evicted to resize it.</li><li>Filtered record streams can cause significant wasted space in the memory blocks.</li><li>Resizing a multi-page allocation is non trivial.</li></ul><h2 id="callback-rules" tabindex="-1">Callback Rules <a class="header-anchor" href="#callback-rules" aria-label="Permalink to &quot;Callback Rules&quot;">​</a></h2><p>Some rules to follow when implementing callbacks:</p><ul><li><p>A callback cannot allocate any memory from the memory manager. If it does it is likely to deadlock.</p></li><li><p>You cannot allocate memory while holding a lock if that lock is also required by a callback.</p><p>Again this will cause deadlock. If it proves impossible you can use a try-lock primitive in the callback, but it means you won&#39;t be able to spill those rows.</p></li><li><p>If the heaps are fragmented it may be more efficient to repack the heaps than spill to disk.</p></li><li><p>If you&#39;re resizing a potentially big block of memory use the resize function with the callback.</p></li></ul><h2 id="resizing-large-memory-blocks" tabindex="-1">Resizing Large memory blocks <a class="header-anchor" href="#resizing-large-memory-blocks" aria-label="Permalink to &quot;Resizing Large memory blocks&quot;">​</a></h2><p>Some of the memory allocations cover more than one &quot;page&quot; - e.g., arrays used to store blocks of rows. (These are called huge pages internally, not to be confused with operating system support for huge pages...) When one of these memory blocks needs to be expanded you need to be careful:</p><ul><li>Allocating a new page, copying, updating the pointer (within a cs) and then freeing is safe. Unfortunately it may involve copying a large chunk of memory. It may also fail if there isn&#39;t memory for the new and old block, even if the existing block could have been expanded into an adjacent block.</li><li>You can&#39;t lock, call a resize routine and update the pointer because the resize routine may need to allocate a new memory block- that may trigger a callback, which could in turn deadlock trying to gain the lock. (The callback may be from another thread...)</li><li>Therefore the memory manager contains a call which allows you to resize a block, but with a callback which is used to atomically update the pointer so it always remains thread safe.</li></ul><h2 id="compacting-heaps" tabindex="-1">Compacting heaps <a class="header-anchor" href="#compacting-heaps" aria-label="Permalink to &quot;Compacting heaps&quot;">​</a></h2><p>Occasionally you have processes which read a large number of rows and then filter them so only a few are still held in memory. Rows tend to be allocated in sequence through the heap pages, which can mean those few remaining rows are scattered over many pages. If they could all be moved to a single page it would free up a significant amount of memory.</p><p>The memory manager contains a function to pack a set of rows into a smaller number of pages: IRowManager-&gt;compactRows().</p><p>This works by iterating through each of the rows in a list. If the row belongs to a heap that could be compacted, and isn&#39;t part of a full heaplet, then the row is moved. Since subsequent rows tend to be allocated from the same heaplet this has the effect of compacting the rows.</p><h1 id="shared-memory" tabindex="-1">Shared Memory <a class="header-anchor" href="#shared-memory" aria-label="Permalink to &quot;Shared Memory&quot;">​</a></h1><p>Much of the time Thor doesn&#39;t uses full memory available to it. If you are running multiple Thor processes on the same machine you may want to configure the system so that each Thor has a private block of memory, but there is also a shared block of memory which can be used by whichever process needs it.</p><p>The ILargeMemCallback provides a mechanism to dynamically allocate more memory to a process as it requires it. This could potentially be done in stages rather than all or nothing.</p><p>(Currently unused as far as I know... the main problem is that borrowing memory needs to be coordinated.)</p><h1 id="huge-pages" tabindex="-1">Huge pages <a class="header-anchor" href="#huge-pages" aria-label="Permalink to &quot;Huge pages&quot;">​</a></h1><p>When OS processes use a large amount of memory, mapping virtual addresses to physical addresses can begin to take a significant proportion of the execution time. This is especially true once the TLB is not large enough to store all the mappings. Huge pages can significantly help with this problem by reducing the number of TLB entries needed to cover the virtual address space. The memory manager supports huge pages in two different ways:</p><p>Huge pages can be preallocated (e.g., with hugeadm) for exclusive use as huge pages. If huge pages are enabled for a particular engine, and sufficient huge pages are available to supply the memory for the memory manager, then they will be used.</p><p>Linux kernels from 2.6.38 onward have support for transparent huge pages. These do not need to be preallocated, instead the operating system tries to use them behind the scenes. HPCC version 5.2 and following takes advantage of this feature to significantly speed memory access up when large amounts of memory are used by each process.</p><p>Preallocated huge pages tend to be more efficient, but they have the disadvantage that the operating system currently does not reuse unused huge pages for other purposes e.g., disk cache.</p><p>There is also a memory manager option to not return the memory to the operating system when it is no longer required. This has the advantage of not clearing the memory whenever it is required again, but the same disadvantage as preallocated huge pages that the unused memory cannot be used for disk cache. We recommend this option is selected when preallocated huge pages are in use - until the kernel allows them to be reused.</p><h1 id="global-memory-and-channels" tabindex="-1">Global memory and channels <a class="header-anchor" href="#global-memory-and-channels" aria-label="Permalink to &quot;Global memory and channels&quot;">​</a></h1><p>Changes in 6.x allow Thor to run multiple channels within the same process. This allows data that is constant for all channels to be shared between all slave channels - a prime example is the rhs of a lookup join. For the queries to run efficiently the memory manager needs to ensure that each slave channel has the same amount of memory - especially when memory is being used that is shared between them.</p><p>createGlobalRowManager() allows a single global row manager to be created which also provides slave row managers for the different channels via the querySlaveRowManager(unsigned slave) method.</p></div></div></main><footer class="VPDocFooter" data-v-e6f2a212 data-v-1bcd8184><!--[--><!--]--><div class="edit-info" data-v-1bcd8184><div class="edit-link" data-v-1bcd8184><a class="VPLink link vp-external-link-icon no-icon edit-link-button" href="https://github.com/hpcc-systems/HPCC-Platform/edit/master/devdoc/MemoryManager.md" target="_blank" rel="noreferrer" data-v-1bcd8184><!--[--><span class="vpi-square-pen edit-link-icon" data-v-1bcd8184></span> Edit this page on GitHub<!--]--></a></div><div class="last-updated" data-v-1bcd8184><p class="VPLastUpdated" data-v-1bcd8184 data-v-1bb0c8a8>Last Updated: <time datetime="2025-07-29T13:25:37.000Z" data-v-1bb0c8a8></time></p></div></div><nav class="prev-next" aria-labelledby="doc-footer-aria-label" data-v-1bcd8184><span class="visually-hidden" id="doc-footer-aria-label" data-v-1bcd8184>Pager</span><div class="pager" data-v-1bcd8184><a class="VPLink link pager-link prev" href="/HPCC-Platform/devdoc/roxie.html" data-v-1bcd8184><!--[--><span class="desc" data-v-1bcd8184>Previous page</span><span class="title" data-v-1bcd8184>Roxie</span><!--]--></a></div><div class="pager" data-v-1bcd8184><a class="VPLink link pager-link next" href="/HPCC-Platform/devdoc/Metrics.html" data-v-1bcd8184><!--[--><span class="desc" data-v-1bcd8184>Next page</span><span class="title" data-v-1bcd8184>Metrics</span><!--]--></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><footer class="VPFooter has-sidebar" data-v-d8b57b2d data-v-566314d4><div class="container" data-v-566314d4><p class="message" data-v-566314d4>Released under the Apache-2.0 License.</p><p class="copyright" data-v-566314d4>Copyright © 2023-present hpccsystems.com</p></div></footer><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"build_me.md\":\"PMcNVT0h\",\"build_utils_builds_file_transfer_readme.md\":\"BHmpn2hD\",\"cmake_modules_documentation.md\":\"BDaL_j9_\",\"dali_sasha_sasha.md\":\"DBLlNS33\",\"devdoc_buildworkflows.md\":\"DxBHBqCq\",\"devdoc_codegenerator.md\":\"BfvNdVuI\",\"devdoc_codereviews.md\":\"DR62xrr1\",\"devdoc_codesubmissions.md\":\"rrGEYjt9\",\"devdoc_dali.md\":\"BTyJFzyM\",\"devdoc_devdocs.md\":\"apeF42kG\",\"devdoc_developerdocs.md\":\"Be2avXAG\",\"devdoc_development.md\":\"Dsk8L6lj\",\"devdoc_devtestwithldap.md\":\"BQxoWSQb\",\"devdoc_docs_contributedocs.md\":\"CJcYckRb\",\"devdoc_docs_doctemplate.md\":\"CRYQGxYM\",\"devdoc_docs_hpccstyleguide.md\":\"BQLcN9pI\",\"devdoc_docs_logcostmitigation.md\":\"Dk6iRYtK\",\"devdoc_endusers.md\":\"CAKiu1Jh\",\"devdoc_gitauthenticate.md\":\"CXe8JBrL\",\"devdoc_ldapsecuritymanager.md\":\"BdIhcf90\",\"devdoc_memorymanager.md\":\"CXiFONGZ\",\"devdoc_metrics.md\":\"Cpce2Nc0\",\"devdoc_newactivity.md\":\"D4Nksaou\",\"devdoc_newfileprocessing.md\":\"BGcWWvGz\",\"devdoc_operations.md\":\"B4sIeNkK\",\"devdoc_qausers.md\":\"CkH6_oKx\",\"devdoc_readme.md\":\"D5m3rKh6\",\"devdoc_roxie.md\":\"DuffRW4z\",\"devdoc_securityconfig.md\":\"AwSEcyhP\",\"devdoc_securityuserauthentication.md\":\"CYg7kLYc\",\"devdoc_styleguide.md\":\"B1MzFfo_\",\"devdoc_testworkflows.md\":\"BuXB56GP\",\"devdoc_userbuildassets.md\":\"OxygBGdk\",\"devdoc_userdoc_azure_tipsandtricks.md\":\"D5JnG2Ha\",\"devdoc_userdoc_azuretipstricks.md\":\"B-bDla1d\",\"devdoc_userdoc_blogs.md\":\"D0cFiA9Y\",\"devdoc_userdoc_copilot_copilotprompttips.md\":\"CJxMSL61\",\"devdoc_userdoc_readme.md\":\"fZHBlH67\",\"devdoc_userdoc_roxie_faq.md\":\"DNCb6aty\",\"devdoc_userdoc_troubleshoot_clientstoolissues.md\":\"7Porr0sH\",\"devdoc_userdoc_wikiguidelines.md\":\"Bvf59ZER\",\"devdoc_versionsupport.md\":\"BlYczwvR\",\"devdoc_workunits.md\":\"gV3npapB\",\"ecl_ecl-bundle_documentation.md\":\"D0XsbPdC\",\"ecllibrary_styleguide.md\":\"Zu4qQI6o\",\"index.md\":\"D7OSPS7P\",\"readme.md\":\"C40L2l-K\",\"system_httplib_readme.md\":\"Muy5rkxW\",\"system_masking_include_readme.md\":\"BbSzavc1\",\"system_masking_plugins_datamasker_readme.md\":\"Db7HQB-0\",\"system_security_plugins_jwtsecurity_readme.md\":\"HbVcNNzw\",\"testing_regress_cleanupreadme.md\":\"BoWuU6zZ\",\"testing_regress_ecl_analyzers_corporate_tmp_readme.md\":\"Bb6tgN7r\",\"testing_regress_ecl_readme.md\":\"B8N14F54\",\"tools_esdlcmd_readme.md\":\"D21za28m\",\"tools_esp-api_readme.md\":\"F4K03kph\",\"tools_tagging_readme.md\":\"DAYVPUg_\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"HPCC Platform\",\"description\":\"The HPCC-Platform from hpccsystems is an open source system for big data analysis. It uses a single language, platform and architecture to process data efficiently and fast.\",\"base\":\"/HPCC-Platform/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"search\":{\"provider\":\"local\"},\"editLink\":{\"pattern\":\"https://github.com/hpcc-systems/HPCC-Platform/edit/master/:path\",\"text\":\"Edit this page on GitHub\"},\"lastUpdated\":{\"text\":\"Last Updated\"},\"nav\":[{\"text\":\"Getting Started\",\"link\":\"/devdoc/README\"},{\"text\":\"hpccsystems.com\",\"link\":\"https://hpccsystems.com\"},{\"text\":\"Changelog\",\"link\":\"https://hpccsystems.com/download/release-notes/\"}],\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/hpcc-systems/HPCC-Platform\"},{\"icon\":\"linkedin\",\"link\":\"https://www.linkedin.com/company/hpcc-systems/home\"},{\"icon\":\"twitter\",\"link\":\"https://twitter.com/hpccsystems\"},{\"icon\":\"facebook\",\"link\":\"https://www.facebook.com/hpccsystems\"},{\"icon\":\"youtube\",\"link\":\"https://www.youtube.com/user/HPCCSystems\"}],\"sidebar\":[{\"text\":\"General\",\"items\":[{\"text\":\"Getting Started\",\"link\":\"/devdoc/README\"},{\"text\":\"Development Guide\",\"link\":\"/devdoc/Development\"},{\"text\":\"C++ Style Guide\",\"link\":\"/devdoc/StyleGuide\"},{\"text\":\"ECL Style Guide\",\"link\":\"/ecllibrary/StyleGuide.html\"},{\"text\":\"Code Submission Guidelines\",\"link\":\"/devdoc/CodeSubmissions\"},{\"text\":\"Code Review Guidelines\",\"link\":\"/devdoc/CodeReviews\"},{\"text\":\"Writing Developer Documentation\",\"link\":\"/devdoc/DevDocs\"},{\"text\":\"User Guides\",\"link\":\"/devdoc/userdoc/README\"},{\"text\":\"Build on Github Actions\",\"link\":\"/devdoc/UserBuildAssets\"}]},{\"text\":\"Other\",\"items\":[{\"text\":\"Workunit Workflow\",\"link\":\"/devdoc/Workunits\"},{\"text\":\"Code Generator\",\"link\":\"/devdoc/CodeGenerator\"},{\"text\":\"Roxie\",\"link\":\"/devdoc/roxie\"},{\"text\":\"Memory Manager\",\"link\":\"/devdoc/MemoryManager\"},{\"text\":\"Metrics\",\"link\":\"/devdoc/Metrics\"},{\"text\":\"Development Testing With LDAP\",\"link\":\"/devdoc/DevTestWithLDAP\"}]}],\"footer\":{\"message\":\"Released under the Apache-2.0 License.\",\"copyright\":\"Copyright © 2023-present hpccsystems.com\"}},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":false}");</script>
    
  </body>
</html>